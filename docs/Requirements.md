# 新 SNS アプリ 要件定義書（MVP v0.2）

## 1. 目的

- 投稿内容のポジティブ度を判定し、一定水準を満たさない投稿はブロック。
- ユーザーに改善提案を提示し、よりポジティブな投稿を促す。
- ポジティブな交流のみを実現する SNS を目指す。

## 2. 認証・権限モデル（MVP）

- 認証方式: OAuth2/OIDC（Authorization Code + PKCE）。IdP は Google と Apple をサポート。
- トークン運用:
  - アクセストークン: 有効期限 15 分。API には `Authorization: Bearer <token>` で送信。
  - リフレッシュトークン: 有効期限 30 日。ローテーション＋再利用検知。`HttpOnly + Secure + SameSite=Lax` なクッキーで保持。
- 閲覧権限:
  - 非ログインでも投稿一覧/詳細（approved のみ）を閲覧可能。
  - 投稿作成・リアクション・通知取得はログイン必須。

## 3. ユースケース

1. ユーザーが下書きを作成/編集（サーバ保存）。
2. 任意で「提案チェック API（保存なしのスコア＋提案）」を呼び、改善のヒントを確認。
3. 公開操作でサーバがスコアリング。
   - しきい値以上 → 投稿公開（approved）。
   - しきい値未満 → 公開ブロック＋改善提案（下書きは維持）。
4. 公開後、他ユーザーはポジティブリアクション（LIKE/EMPATHY/THANKS/SUPPORT）を付与。

## 4. 機能要件（MVP）

- 下書き機能: `create/read/update/delete`、`publish`。公開後の編集は不可（修正は削除→再投稿）。
- 投稿機能: タイムライン（新着順）・詳細取得。本人による削除/復元（後述ポリシー）。
- ポジティブ度判定: Gemini API によるスコアリング。timeout 1000ms、しきい値 0.70、提案最大 3 件。
- 提案チェック API: 保存せず入力テキストに対してスコアと提案を返却。
- リアクション機能（方針A）: 1投稿につき同時に1種類のみ付与可能。別種類を付与すると置き換え。同一種類は冪等（無視/204）。
- 通知機能: 自分の投稿へのリアクション通知一覧。
- ヘルスチェック: `/healthz` で稼働確認。

## 5. 非機能要件

- レイテンシ: p95 1.5 秒以内（公開/下書き保存/リアクション）。
- 可用性: 99.9% / 月。
- セキュリティ:
  - OIDC（Google/Apple）。TLS 必須。CORS 設定（下記）。
  - リフレッシュ API のみ CSRF 対策（クッキー運用のため）。
- レート制限（RPM=1分あたり）:
  - 匿名: 投稿一覧 60、投稿詳細 120。
  - 認証: 下書き作成 30、公開 6、リアクション作成/取消 各30、提案チェック 20。
- 冪等性: 書き込み系は `Idempotency-Key` を推奨。
- CORS 許可オリジン: `http://localhost:3000`、`https://stg.app.posipost.example.com`、`https://app.posipost.example.com`（credentials 許可）。

## 6. データ/運用ポリシー

- 削除ポリシー: ソフト削除→30日後に自動ハード削除（推奨）。
  - リアクション/通知も連鎖してソフト→ハード削除。
  - 削除済みURLは 404。30日以内は本人が復元可。
- 保持期間（retention）:
  - approved投稿: ユーザー削除まで（恒久）。
  - 下書き: 90 日（無操作で自動削除）。
  - ブロック判定データ（score/threshold/suggestions）: 30 日。
  - 監査ログ（作成/公開/削除/復元/反応）: 180 日。
  - アクセスログ（匿名IP/UA含む）: 30 日。

## 7. データモデルとID

- ID形式: UUID v7 を採用（API表現は `format: uuid`）。
- 投稿状態: `approved` のみ（公開後編集不可）。下書きは別リソース。
- 言語: 日本語のみ対応。APIの `lang` フィールドは持たない。

## 8. リリース範囲

- 初期リリース（MVP）: 下書き→公開フロー、提案チェック、ポジティブリアクション、通知、公開閲覧（非ログイン可）。
- 将来拡張（Out of Scope）: 異議申立て、管理ダッシュボード、フォロワー限定公開、多言語対応、通報/ブロック機能 等。

